- name: Webapplication with database

  hosts:
    - localhost

  become: yes

tasks:
  - name: Install nginx
    package:
      name: nginx
      state: present

  - name: Start nginx
    service:
      name: nginx
      state: started

  - name: Remove nginx.conf
    file:
      path: /etc/nginx/nginx.conf
      state: absent

  - name: Get config for nginx
    aws_s3:
      bucket: wordpressfiles
      object: nginx.conf
      dest: /etc/nginx/nginx.conf
      mode: get

  - name: Remove default.conf
    file:
      path: /etc/nginx/conf.d/default.conf
      state: absent

  - name: Get  default.conf for nginx
    aws_s3:
      bucket: wordpressfiles
      object: default.conf
      dest: /etc/nginx/conf.d/default.conf
      mode: get

  - name: Create a directory
    file:
      path: /run/php-fpm
      state: directory
      mode: '0755'

  - name: Remove default.conf
    file:
      path: /etc/nginx/sites-enabled/default
      state: absent

  - name: Reload nginx for new configuration
      service:
        name: nginx
        state: reloaded

  - name: Install PHP-FPM
    apt:
      name: "{{ item }}"
      state: latest
    with_items:
      - php-fpm
      - php-curl
      - php-json
      - php-xmlrpc
      - php-gd
      - php-xml
      - php-mbstring
      - php-mysql
      - monit

  - name: Start monit
    service:
      name: monit
      state: started

  - name: Create a directory
    file:
      path: /run/php-fpm
      state: directory
      mode: '0755'

  - name: Remove file php-fpm.conf
    file:
      path: /etc/php/7.3/fpm/php-fpm.con
      state: absent

  - name: Get config php-fpm.conf
    aws_s3:
      bucket: wordpressfiles
      object: php-fpm.conf
      dest: /etc/php/7.3/fpm/php-fpm.conf
      mode: get

  - name: Remove file www.conf
    file:
      path: /etc/php/7.3/fpm/pool.d/www.conf
      state: absent

  - name: Get www.conf for php
    aws_s3:
      bucket: wordpressfiles
      object: www.conf
      dest: /etc/php/7.3/fpm/pool.d/www.conf
      mode: get

  - name: Remove file php.ini
    file:
      path: /etc/php/7.3/fpm/php.ini
      state: absent

  - name: Get php.ini config for php
    aws_s3:
      bucket: wordpressfiles
      object: php.ini
      dest: /etc/php/7.3/fpm/php.ini
      mode: get

  - name: Reload fpm for new configuration
      service:
        name: php7.3-fpm
        state: restarted

  - name: Add the user 'pepega'
    user:
      name: pepega
      group: sudo
      shell: /bin/bash
      create_home: true

  - name: Create a directory
    file:
      path: /home/pepega/logs
      state: directory
      mode: '0755'

  - name: Create php-fpm vhost pool config file
    aws_s3:
      bucket: wordpressfiles
      object: pepega.conf
      dest: /etc/php/7.3/fpm/pool.d/pepega.conf
      mode: get

  - name: Remove www.conf
    file:
      path: /etc/php/7.3/fpm/pool.d/www.conf
      state: absent

  - name: Create the php-fpm logfile
    file:
      path: /home/pepega/logs/phpfpm_error.log
      state: touch
      mode: u=rw,g=r,o=r

